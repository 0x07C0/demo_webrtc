<style>
  * {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>

<div id="remoteVideos" style="position: absolute;"></div>
<div id="logs" style="position: absolute;"></div>

<script>
  /* eslint-env browser */
  let pc = new RTCPeerConnection({
    iceServers: [
      {
        urls: 'stun:stun.l.google.com:19302'
      }
    ]
  })
  var log = msg => {
    document.getElementById('logs').innerHTML += msg + '<br>'
  }

  log("Requesting user video and audio");
  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
      log("Creating a local description");
      pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log)
    }).catch(log)

  pc.oniceconnectionstatechange = e => log(pc.iceConnectionState)
  pc.onicecandidate = async event => {
    if (event.candidate === null) {
      log("Sending offer")
      let desc = btoa(JSON.stringify(pc.localDescription));
      let response = await fetch("/local", {
        method: "POST",
        body: desc
      });
      let offer = await response.text();
      log("Setting remote description for offer response");
      try {
        pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(offer))))
        log("Connected successfully");
      } catch (e) {
        alert(e)
      }
    }
  }
  pc.ontrack = function (event) {
    var el = document.createElement(event.track.kind)
    el.srcObject = event.streams[0]
    if (event.track.kind == "audio") {
      el.hidden = true;
    }
    el.autoplay = true;
    el.controls = false;


    document.getElementById('remoteVideos').appendChild(el)
  }
</script>